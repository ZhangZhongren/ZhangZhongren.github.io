## 指数补偿

弱网情况下保证请求能顺利发送的一种方法

``` js
const fetch = require('node-fetch')
function request(url){
  let resolved = false
  let t = 1 
  return new Promise((resolve) => {
    function doFetch(){
      if(resolved || t > 16) {
        return
      }
      
      fetch(url).then((resp) => {
        return resp.text()
      })
      .then(data => {
        if(!resolved) {
          resolved = true
          resolve(data)
          console.log('t=', t)
        }
      })
      .catch(ex => {
        console.error(ex)
      })
      setTimeout(() => {
        doFetch()
        t *= 2
      }, t * 100)
    }
    doFetch()
  })
}

request('http://www.baidu.com')
  .then(data => {
    console.log(data.length)
  })

```

## 窗口抖动

防止在一段时间内相同的请求多次发送

``` js
const fetch = require('node-fetch')

function hash(args) {
  return args.join(',')
}
function window(f, time = 50) {
  let window = {} 
  let flag = false 
  return (...args) => {
    return new Promise((resolve) => {
      if (!window[hash(args)]) {
        window[hash(args)] = {
          func: f,
          args,
          resolvers: [],
        }
      }
      if (!flag) {
        flag = true
        setTimeout(() => {
          Object.keys(window).forEach((key) => {
            const { func, args, resolvers } = window[key]
            const promise = func(...args)
              .then((resp) => resp.text())
              .then((text) =>
                resolvers.map((r) => {
                  r(text)
                })
              )
          })
          flag = false
        }, time)
      }
      console.log(args)
      window[hash(args)].resolvers.push(resolve)
    })
  }
}

const request = window(fetch, 20)

request('http://www.baidu.com')
  .then(txt => console.log(txt.length))
request('http://www.baidu.com')
  .then(txt => console.log(txt.length))
request('http://www.baidu.com')
  .then(txt => console.log(txt.length))

request('http://www.zhihu.com')
  .then(txt => console.log(txt.length))
request('http://www.baidu.com')
  .then(txt => console.log(txt.length))
request('http://www.baidu.com')
  .then(txt => console.log(txt.length))
```